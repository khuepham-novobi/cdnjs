"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var turnOrder=require("./turn-order-f57ce2a9.js"),base=require("./base-3237f024.js"),master=require("./master-bdf5cae3.js"),ioNamespace=require("socket.io-client"),ioNamespace__default=_interopDefault(ioNamespace);class InMemory extends base.Sync{constructor(){super(),this.state=new Map,this.initial=new Map,this.metadata=new Map,this.log=new Map}createMatch(t,e){this.initial.set(t,e.initialState),this.setState(t,e.initialState),this.setMetadata(t,e.metadata)}setMetadata(t,e){this.metadata.set(t,e)}setState(t,e,s){if(s&&s.length>0){const e=this.log.get(t)||[];this.log.set(t,e.concat(s))}this.state.set(t,e)}fetch(t,e){const s={};return e.state&&(s.state=this.state.get(t)),e.metadata&&(s.metadata=this.metadata.get(t)),e.log&&(s.log=this.log.get(t)||[]),e.initialState&&(s.initialState=this.initial.get(t)),s}wipe(t){this.state.delete(t),this.metadata.delete(t)}listMatches(t){return[...this.metadata.entries()].filter(([,e])=>{if(!t)return!0;if(void 0!==t.gameName&&e.gameName!==t.gameName)return!1;if(void 0!==t.where){if(void 0!==t.where.isGameover){if(void 0!==e.gameover!==t.where.isGameover)return!1}if(void 0!==t.where.updatedBefore&&e.updatedAt>=t.where.updatedBefore)return!1;if(void 0!==t.where.updatedAfter&&e.updatedAt<=t.where.updatedAfter)return!1}return!0}).map(([t])=>t)}}class WithLocalStorageMap extends Map{constructor(t){super(),this.key=t,(JSON.parse(localStorage.getItem(this.key))||[]).forEach(t=>this.set(...t))}sync(){const t=[...this.entries()];localStorage.setItem(this.key,JSON.stringify(t))}set(t,e){return super.set(t,e),this.sync(),this}delete(t){const e=super.delete(t);return this.sync(),e}}class LocalStorage extends InMemory{constructor(t="bgio"){super();const e=e=>new WithLocalStorageMap(`${t}_${e}`);this.state=e("state"),this.initial=e("initial"),this.metadata=e("metadata"),this.log=e("log")}}class Transport{constructor({store:t,gameName:e,playerID:s,matchID:a,credentials:i,numPlayers:r}){this.store=t,this.gameName=e||"default",this.playerID=s||null,this.matchID=a||"default",this.credentials=i,this.numPlayers=r||2}}function GetBotPlayer(t,e){if(void 0!==t.ctx.gameover)return null;if(t.ctx.activePlayers){for(const s of Object.keys(e))if(s in t.ctx.activePlayers)return s}else if(t.ctx.currentPlayer in e)return t.ctx.currentPlayer;return null}class LocalMaster extends master.Master{constructor({game:t,bots:e,storageKey:s,persist:a}){const i={},r={};if(t&&t.ai&&e)for(const s in e){const a=e[s];r[s]=new a({game:t,enumerate:t.ai.enumerate,seed:t.seed})}const c=({playerID:t,...e})=>{const s=i[t];void 0!==s&&s(e)},n={send:c,sendAll:t=>{for(const e in i){const s=t(e);c({playerID:e,...s})}}};super(t,a?new LocalStorage(s):new InMemory,n),this.connect=((t,e,s)=>{i[e]=s}),this.subscribe(({state:t,matchID:s})=>{if(!e)return;const a=GetBotPlayer(t,r);null!==a&&setTimeout(async()=>{const e=await r[a].play(t,a);await this.onUpdate(e.action,t._stateID,s,e.action.payload.playerID)},100)})}}class LocalTransport extends Transport{constructor({master:t,store:e,matchID:s,playerID:a,credentials:i,gameName:r,numPlayers:c}){super({store:e,gameName:r,playerID:a,matchID:s,credentials:i,numPlayers:c}),this.master=t,this.isConnected=!0}onChatMessage(t,e){const s=[t,e,this.credentials];this.master.onChatMessage(...s)}async onUpdate(t,e,s){const a=this.store.getState();if(t==this.matchID&&e._stateID>=a._stateID){const t=turnOrder.update(e,s);this.store.dispatch(t)}}onSync(t,e){if(t==this.matchID){const t=turnOrder.sync(e);this.store.dispatch(t)}}onAction(t,e){this.master.onUpdate(e,t._stateID,this.matchID,this.playerID)}connect(){this.master.connect(this.matchID,this.playerID,t=>{switch(t.type){case"sync":return this.onSync(...t.args);case"update":return this.onUpdate(...t.args);case"chat":return this.chatMessageCallback(t.args[1])}}),this.master.onSync(this.matchID,this.playerID,this.credentials,this.numPlayers)}disconnect(){}subscribe(){}subscribeMatchData(){}subscribeChatMessage(t){this.chatMessageCallback=t}resetAndSync(){const t=turnOrder.reset(null);this.store.dispatch(t),this.connect()}updateMatchID(t){this.matchID=t,this.resetAndSync()}updatePlayerID(t){this.playerID=t,this.resetAndSync()}updateCredentials(t){this.credentials=t,this.resetAndSync()}}const localMasters=new Map;function Local({bots:t,persist:e,storageKey:s}={}){return a=>{const{gameKey:i,game:r}=a;let c;const n=localMasters.get(i);return n&&n.bots===t&&n.storageKey===s&&n.persist===e&&(c=n.master),c||(c=new LocalMaster({game:r,bots:t,persist:e,storageKey:s}),localMasters.set(i,{master:c,bots:t,persist:e,storageKey:s})),new LocalTransport({master:c,...a})}}const io=ioNamespace__default;class SocketIOTransport extends Transport{constructor({socket:t,socketOpts:e,store:s,matchID:a,playerID:i,credentials:r,gameName:c,numPlayers:n,server:o}={}){super({store:s,gameName:c,playerID:i,matchID:a,credentials:r,numPlayers:n}),this.server=o,this.socket=t,this.socketOpts=e,this.isConnected=!1,this.callback=(()=>{}),this.matchDataCallback=(()=>{}),this.chatMessageCallback=(()=>{})}onAction(t,e){const s=[e,t._stateID,this.matchID,this.playerID];this.socket.emit("update",...s)}onChatMessage(t,e){const s=[t,e,this.credentials];this.socket.emit("chat",...s)}connect(){if(!this.socket)if(this.server){let t=this.server;-1==t.search(/^https?:\/\//)&&(t="http://"+this.server),"/"!=t.slice(-1)&&(t+="/"),this.socket=io(t+this.gameName,this.socketOpts)}else this.socket=io("/"+this.gameName,this.socketOpts);this.socket.on("update",(t,e,s)=>{const a=this.store.getState();if(t==this.matchID&&e._stateID>=a._stateID){const t=turnOrder.update(e,s);this.store.dispatch(t)}}),this.socket.on("sync",(t,e)=>{if(t==this.matchID){const t=turnOrder.sync(e);this.matchDataCallback(e.filteredMetadata),this.store.dispatch(t)}}),this.socket.on("matchData",(t,e)=>{t==this.matchID&&this.matchDataCallback(e)}),this.socket.on("chat",(t,e)=>{t===this.matchID&&this.chatMessageCallback(e)}),this.socket.on("connect",()=>{this.sync(),this.isConnected=!0,this.callback()}),this.socket.on("disconnect",()=>{this.isConnected=!1,this.callback()})}disconnect(){this.socket.close(),this.socket=null,this.isConnected=!1,this.callback()}subscribe(t){this.callback=t}subscribeMatchData(t){this.matchDataCallback=t}subscribeChatMessage(t){this.chatMessageCallback=t}sync(){if(this.socket){const t=[this.matchID,this.playerID,this.credentials,this.numPlayers];this.socket.emit("sync",...t)}}resetAndSync(){const t=turnOrder.reset(null);this.store.dispatch(t),this.sync()}updateMatchID(t){this.matchID=t,this.resetAndSync()}updatePlayerID(t){this.playerID=t,this.resetAndSync()}updateCredentials(t){this.credentials=t,this.resetAndSync()}}function SocketIO({server:t,socketOpts:e}={}){return s=>new SocketIOTransport({server:t,socketOpts:e,...s})}exports.Local=Local,exports.SocketIO=SocketIO;