"use strict";var turnOrder=require("./turn-order-f57ce2a9.js"),reducer=require("./reducer-85e302af.js");class Bot{constructor({enumerate:t,seed:e}){this.enumerateFn=t,this.seed=e,this.iterationCounter=0,this._opts={}}addOpt({key:t,range:e,initial:a}){this._opts[t]={range:e,value:a}}getOpt(t){return this._opts[t].value}setOpt(t,e){t in this._opts&&(this._opts[t].value=e)}opts(){return this._opts}enumerate(t,e,a){return this.enumerateFn(t,e,a).map(t=>"payload"in t?t:"move"in t?turnOrder.makeMove(t.move,t.args,a):"event"in t?turnOrder.gameEvent(t.event,t.args,a):void 0)}random(t){let e;if(void 0!==this.seed){const t=this.prngstate?"":this.seed,a=turnOrder.alea(t,this.prngstate);e=a(),this.prngstate=a.state()}else e=Math.random();if(t){if(Array.isArray(t)){return t[Math.floor(e*t.length)]}return Math.floor(e*t)}return e}}const CHUNK_SIZE=25;class MCTSBot extends Bot{constructor({enumerate:t,seed:e,objectives:a,game:r,iterations:i,playoutDepth:s,iterationCallback:n}){super({enumerate:t,seed:e}),void 0===a&&(a=(()=>({}))),this.objectives=a,this.iterationCallback=n||(()=>{}),this.reducer=reducer.CreateGameReducer({game:r}),this.iterations=i,this.playoutDepth=s,this.addOpt({key:"async",initial:!1}),this.addOpt({key:"iterations",initial:"number"==typeof i?i:1e3,range:{min:1,max:2e3}}),this.addOpt({key:"playoutDepth",initial:"number"==typeof s?s:50,range:{min:1,max:100}})}createNode({state:t,parentAction:e,parent:a,playerID:r}){const{G:i,ctx:s}=t;let n=[],o=[];if(void 0!==r)n=this.enumerate(i,s,r),o=this.objectives(i,s,r);else if(s.activePlayers)for(const t in s.activePlayers)n=n.concat(this.enumerate(i,s,t)),o=o.concat(this.objectives(i,s,t));else n=n.concat(this.enumerate(i,s,s.currentPlayer)),o=o.concat(this.objectives(i,s,s.currentPlayer));return{state:t,parent:a,parentAction:e,actions:n,objectives:o,children:[],visits:0,value:0}}select(t){if(t.actions.length>0)return t;if(0==t.children.length)return t;let e=null,a=0;for(const r of t.children){const i=r.visits+Number.EPSILON,s=r.value/i+Math.sqrt(2*Math.log(t.visits)/i);(null==e||s>a)&&(a=s,e=r)}return this.select(e)}expand(t){const e=t.actions;if(0==e.length||void 0!==t.state.ctx.gameover)return t;const a=this.random(e.length),r=e[a];t.actions.splice(a,1);const i=this.reducer(t.state,r),s=this.createNode({state:i,parentAction:r,parent:t});return t.children.push(s),s}playout({state:t}){let e=this.getOpt("playoutDepth");"function"==typeof this.playoutDepth&&(e=this.playoutDepth(t.G,t.ctx));for(let a=0;a<e&&void 0===t.ctx.gameover;a++){const{G:e,ctx:a}=t;let r=a.currentPlayer;a.activePlayers&&(r=Object.keys(a.activePlayers)[0]);const i=this.enumerate(e,a,r),s=this.objectives(e,a,r),n=Object.keys(s).reduce((t,r)=>{const i=s[r];return i.checker(e,a)?t+i.weight:t},0);if(n>0)return{score:n};if(!i||0==i.length)return;const o=this.random(i.length);t=this.reducer(t,i[o])}return t.ctx.gameover}backpropagate(t,e={}){t.visits++,void 0!==e.score&&(t.value+=e.score),!0===e.draw&&(t.value+=.5),t.parentAction&&e.winner===t.parentAction.payload.playerID&&t.value++,t.parent&&this.backpropagate(t.parent,e)}play(t,e){const a=this.createNode({state:t,playerID:e});let r=this.getOpt("iterations");"function"==typeof this.iterations&&(r=this.iterations(t.G,t.ctx));const i=()=>{let t=null;for(const e of a.children)(null==t||e.visits>t.visits)&&(t=e);return{action:t&&t.parentAction,metadata:a}};return new Promise(t=>{const e=()=>{for(let t=0;t<CHUNK_SIZE&&this.iterationCounter<r;t++){const t=this.select(a),e=this.expand(t),r=this.playout(e);this.backpropagate(e,r),this.iterationCounter++}this.iterationCallback({iterationCounter:this.iterationCounter,numIterations:r,metadata:a})};if(this.iterationCounter=0,this.getOpt("async")){const a=()=>{this.iterationCounter<r?(e(),setTimeout(a,0)):t(i())};a()}else{for(;this.iterationCounter<r;)e();t(i())}})}}class RandomBot extends Bot{play({G:t,ctx:e},a){const r=this.enumerate(t,e,a);return Promise.resolve({action:this.random(r)})}}async function Step(t,e){const a=t.store.getState();let r=a.ctx.currentPlayer;a.ctx.activePlayers&&(r=Object.keys(a.ctx.activePlayers)[0]);const{action:i,metadata:s}=await e.play(a,r);if(i){const e={...i,payload:{...i.payload,metadata:s}};return t.store.dispatch(e),e}}async function Simulate({game:t,bots:e,state:a,depth:r}){void 0===r&&(r=1e4);const i=reducer.CreateGameReducer({game:t});let s=null,n=0;for(;void 0===a.ctx.gameover&&n<r;){let t=a.ctx.currentPlayer;a.ctx.activePlayers&&(t=Object.keys(a.ctx.activePlayers)[0]);const r=e instanceof Bot?e:e[t],o=await r.play(a,t);if(!o.action)break;s=o.metadata,a=i(a,o.action),n++}return{state:a,metadata:s}}exports.Bot=Bot,exports.MCTSBot=MCTSBot,exports.RandomBot=RandomBot,exports.Simulate=Simulate,exports.Step=Step;