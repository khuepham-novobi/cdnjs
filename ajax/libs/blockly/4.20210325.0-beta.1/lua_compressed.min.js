!function(e,a){"function"==typeof define&&define.amd?define(["./blockly_compressed.js"],a):"object"==typeof exports?module.exports=a(require("./blockly_compressed.js")):e.Blockly.Lua=a(e.Blockly)}(this,function(E){"use strict";return E.Lua=new E.Generator("Lua"),E.Lua.addReservedWords("_,__inext,assert,bit,colors,colours,coroutine,disk,dofile,error,fs,fetfenv,getmetatable,gps,help,io,ipairs,keys,loadfile,loadstring,math,native,next,os,paintutils,pairs,parallel,pcall,peripheral,print,printError,rawequal,rawget,rawset,read,rednet,redstone,rs,select,setfenv,setmetatable,sleep,string,table,term,textutils,tonumber,tostring,turtle,type,unpack,vector,write,xpcall,_VERSION,__indext,HTTP,and,break,do,else,elseif,end,false,for,function,if,in,local,nil,not,or,repeat,return,then,true,until,while,add,sub,mul,div,mod,pow,unm,concat,len,eq,lt,le,index,newindex,call,assert,collectgarbage,dofile,error,_G,getmetatable,inpairs,load,loadfile,next,pairs,pcall,print,rawequal,rawget,rawlen,rawset,select,setmetatable,tonumber,tostring,type,_VERSION,xpcall,require,package,string,table,math,bit32,io,file,os,debug"),E.Lua.ORDER_ATOMIC=0,E.Lua.ORDER_HIGH=1,E.Lua.ORDER_EXPONENTIATION=2,E.Lua.ORDER_UNARY=3,E.Lua.ORDER_MULTIPLICATIVE=4,E.Lua.ORDER_ADDITIVE=5,E.Lua.ORDER_CONCATENATION=6,E.Lua.ORDER_RELATIONAL=7,E.Lua.ORDER_AND=8,E.Lua.ORDER_OR=9,E.Lua.ORDER_NONE=99,E.Lua.isInitialized=!1,E.Lua.init=function(e){E.Lua.definitions_=Object.create(null),E.Lua.functionNames_=Object.create(null),E.Lua.variableDB_?E.Lua.variableDB_.reset():E.Lua.variableDB_=new E.Names(E.Lua.RESERVED_WORDS_),E.Lua.variableDB_.setVariableMap(e.getVariableMap()),this.isInitialized=!0},E.Lua.finish=function(e){var a,t=[];for(a in E.Lua.definitions_)t.push(E.Lua.definitions_[a]);return delete E.Lua.definitions_,delete E.Lua.functionNames_,E.Lua.variableDB_.reset(),t.join("\n\n")+"\n\n\n"+e},E.Lua.scrubNakedValue=function(e){return"local _ = "+e+"\n"},E.Lua.quote_=function(e){return"'"+(e=e.replace(/\\/g,"\\\\").replace(/\n/g,"\\\n").replace(/'/g,"\\'"))+"'"},E.Lua.multiline_quote_=function(e){return e.split(/\n/g).map(E.Lua.quote_).join(" .. '\\n' ..\n")},E.Lua.scrub_=function(e,a,t){var u="";if(!e.outputConnection||!e.outputConnection.targetConnection){var n=e.getCommentText();n&&(n=E.utils.string.wrap(n,E.Lua.COMMENT_WRAP-3),u+=E.Lua.prefixLines(n,"-- ")+"\n");for(var r=0;r<e.inputList.length;r++)e.inputList[r].type==E.INPUT_VALUE&&(n=e.inputList[r].connection.targetBlock())&&(n=E.Lua.allNestedComments(n))&&(u+=E.Lua.prefixLines(n,"-- "))}return e=e.nextConnection&&e.nextConnection.targetBlock(),u+a+(t=t?"":E.Lua.blockToCode(e))},E.Lua.colour={},E.Lua.colour_picker=function(e){return[E.Lua.quote_(e.getFieldValue("COLOUR")),E.Lua.ORDER_ATOMIC]},E.Lua.colour_random=function(e){return['string.format("#%06x", math.random(0, 2^24 - 1))',E.Lua.ORDER_HIGH]},E.Lua.colour_rgb=function(e){return[E.Lua.provideFunction_("colour_rgb",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(r, g, b)","  r = math.floor(math.min(100, math.max(0, r)) * 2.55 + .5)","  g = math.floor(math.min(100, math.max(0, g)) * 2.55 + .5)","  b = math.floor(math.min(100, math.max(0, b)) * 2.55 + .5)",'  return string.format("#%02x%02x%02x", r, g, b)',"end"])+"("+(E.Lua.valueToCode(e,"RED",E.Lua.ORDER_NONE)||0)+", "+(E.Lua.valueToCode(e,"GREEN",E.Lua.ORDER_NONE)||0)+", "+(e=E.Lua.valueToCode(e,"BLUE",E.Lua.ORDER_NONE)||0)+")",E.Lua.ORDER_HIGH]},E.Lua.colour_blend=function(e){return[E.Lua.provideFunction_("colour_blend",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(colour1, colour2, ratio)","  local r1 = tonumber(string.sub(colour1, 2, 3), 16)","  local r2 = tonumber(string.sub(colour2, 2, 3), 16)","  local g1 = tonumber(string.sub(colour1, 4, 5), 16)","  local g2 = tonumber(string.sub(colour2, 4, 5), 16)","  local b1 = tonumber(string.sub(colour1, 6, 7), 16)","  local b2 = tonumber(string.sub(colour2, 6, 7), 16)","  local ratio = math.min(1, math.max(0, ratio))","  local r = math.floor(r1 * (1 - ratio) + r2 * ratio + .5)","  local g = math.floor(g1 * (1 - ratio) + g2 * ratio + .5)","  local b = math.floor(b1 * (1 - ratio) + b2 * ratio + .5)",'  return string.format("#%02x%02x%02x", r, g, b)',"end"])+"("+(E.Lua.valueToCode(e,"COLOUR1",E.Lua.ORDER_NONE)||"'#000000'")+", "+(E.Lua.valueToCode(e,"COLOUR2",E.Lua.ORDER_NONE)||"'#000000'")+", "+(e=E.Lua.valueToCode(e,"RATIO",E.Lua.ORDER_NONE)||0)+")",E.Lua.ORDER_HIGH]},E.Lua.lists={},E.Lua.lists_create_empty=function(e){return["{}",E.Lua.ORDER_HIGH]},E.Lua.lists_create_with=function(e){for(var a=Array(e.itemCount_),t=0;t<e.itemCount_;t++)a[t]=E.Lua.valueToCode(e,"ADD"+t,E.Lua.ORDER_NONE)||"None";return["{"+a.join(", ")+"}",E.Lua.ORDER_HIGH]},E.Lua.lists_repeat=function(e){return[E.Lua.provideFunction_("create_list_repeated",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(item, count)","  local t = {}","  for i = 1, count do","    table.insert(t, item)","  end","  return t","end"])+"("+(E.Lua.valueToCode(e,"ITEM",E.Lua.ORDER_NONE)||"None")+", "+(e=E.Lua.valueToCode(e,"NUM",E.Lua.ORDER_NONE)||"0")+")",E.Lua.ORDER_HIGH]},E.Lua.lists_length=function(e){return["#"+(E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_UNARY)||"{}"),E.Lua.ORDER_UNARY]},E.Lua.lists_isEmpty=function(e){return["#"+(E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_UNARY)||"{}")+" == 0",E.Lua.ORDER_RELATIONAL]},E.Lua.lists_indexOf=function(e){var a=E.Lua.valueToCode(e,"FIND",E.Lua.ORDER_NONE)||"''",t=E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_NONE)||"{}";return[("FIRST"==e.getFieldValue("END")?E.Lua.provideFunction_("first_index",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t, elem)","  for k, v in ipairs(t) do","    if v == elem then","      return k","    end","  end","  return 0","end"]):E.Lua.provideFunction_("last_index",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t, elem)","  for i = #t, 1, -1 do","    if t[i] == elem then","      return i","    end","  end","  return 0","end"]))+"("+t+", "+a+")",E.Lua.ORDER_HIGH]},E.Lua.lists.getIndex_=function(e,a,t){return"FIRST"==a?"1":"FROM_END"==a?"#"+e+" + 1 - "+t:"LAST"==a?"#"+e:"RANDOM"==a?"math.random(#"+e+")":t},E.Lua.lists_getIndex=function(e){var a=e.getFieldValue("MODE")||"GET",t=e.getFieldValue("WHERE")||"FROM_START",u=E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_HIGH)||"({})",n=E.Lua.lists.getIndex_;if("LAST"!=t&&"FROM_END"!=t&&"RANDOM"!=t||u.match(/^\w+$/))return r="GET"==a&&"FROM_END"==t?E.Lua.ORDER_ADDITIVE:E.Lua.ORDER_NONE,e=n(u,t,e=E.Lua.valueToCode(e,"AT",r)||"1"),"GET"==a?[u+"["+e+"]",E.Lua.ORDER_HIGH]:(t="table.remove("+u+", "+e+")","GET_REMOVE"==a?[t,E.Lua.ORDER_HIGH]:t+"\n");if("REMOVE"!=a)return e=E.Lua.valueToCode(e,"AT",E.Lua.ORDER_NONE)||"1",[("GET"==a?E.Lua.provideFunction_("list_get_"+t.toLowerCase(),["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t"+("FROM_END"==t||"FROM_START"==t?", at)":")"),"  return t["+n("t",t,"at")+"]","end"]):E.Lua.provideFunction_("list_remove_"+t.toLowerCase(),["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t"+("FROM_END"==t||"FROM_START"==t?", at)":")"),"  return table.remove(t, "+n("t",t,"at")+")","end"]))+"("+u+("FROM_END"==t||"FROM_START"==t?", "+e:"")+")",E.Lua.ORDER_HIGH];var r="FROM_END"==t?E.Lua.ORDER_ADDITIVE:E.Lua.ORDER_NONE;return e=E.Lua.valueToCode(e,"AT",r)||"1",(a=E.Lua.variableDB_.getDistinctName("tmp_list",E.VARIABLE_CATEGORY_NAME))+" = "+u+"\ntable.remove("+a+", "+(e=n(a,t,e))+")\n"},E.Lua.lists_setIndex=function(e){var a=E.Lua.valueToCode(e,"LIST",E.Lua.ORDER_HIGH)||"{}",t=e.getFieldValue("MODE")||"SET",u=e.getFieldValue("WHERE")||"FROM_START",n=E.Lua.valueToCode(e,"AT",E.Lua.ORDER_ADDITIVE)||"1";e=E.Lua.valueToCode(e,"TO",E.Lua.ORDER_NONE)||"None";var r,o=E.Lua.lists.getIndex_,i="";return"LAST"!=u&&"FROM_END"!=u&&"RANDOM"!=u||a.match(/^\w+$/)||(i=(r=E.Lua.variableDB_.getDistinctName("tmp_list",E.VARIABLE_CATEGORY_NAME))+" = "+a+"\n",a=r),(i="SET"==t?i+(a+"["+o(a,u,n))+"] = "+e:i+("table.insert("+a+", "+o(a,u,n))+("LAST"==u?" + 1":"")+", "+e+")")+"\n"},E.Lua.lists_getSublist=function(e){var a=E.Lua.valueToCode(e,"LIST",E.Lua.ORDER_NONE)||"{}",t=e.getFieldValue("WHERE1"),u=e.getFieldValue("WHERE2"),n=E.Lua.valueToCode(e,"AT1",E.Lua.ORDER_NONE)||"1";e=E.Lua.valueToCode(e,"AT2",E.Lua.ORDER_NONE)||"1";var r=E.Lua.lists.getIndex_;return[E.Lua.provideFunction_("list_sublist_"+t.toLowerCase()+"_"+u.toLowerCase(),["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(source"+("FROM_END"==t||"FROM_START"==t?", at1":"")+("FROM_END"==u||"FROM_START"==u?", at2":"")+")","  local t = {}","  local start = "+r("source",t,"at1"),"  local finish = "+r("source",u,"at2"),"  for i = start, finish do","    table.insert(t, source[i])","  end","  return t","end"])+"("+a+("FROM_END"==t||"FROM_START"==t?", "+n:"")+("FROM_END"==u||"FROM_START"==u?", "+e:"")+")",E.Lua.ORDER_HIGH]},E.Lua.lists_sort=function(e){var a=E.Lua.valueToCode(e,"LIST",E.Lua.ORDER_NONE)||"{}",t="1"===e.getFieldValue("DIRECTION")?1:-1;return e=e.getFieldValue("TYPE"),[E.Lua.provideFunction_("list_sort",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(list, typev, direction)","  local t = {}","  for n,v in pairs(list) do table.insert(t, v) end","  local compareFuncs = {","    NUMERIC = function(a, b)","      return (tonumber(tostring(a)) or 0)","          < (tonumber(tostring(b)) or 0) end,","    TEXT = function(a, b)","      return tostring(a) < tostring(b) end,","    IGNORE_CASE = function(a, b)","      return string.lower(tostring(a)) < string.lower(tostring(b)) end","  }","  local compareTemp = compareFuncs[typev]","  local compare = compareTemp","  if direction == -1","  then compare = function(a, b) return compareTemp(b, a) end","  end","  table.sort(t, compare)","  return t","end"])+"("+a+',"'+e+'", '+t+")",E.Lua.ORDER_HIGH]},E.Lua.lists_split=function(e){var a=E.Lua.valueToCode(e,"INPUT",E.Lua.ORDER_NONE),t=E.Lua.valueToCode(e,"DELIM",E.Lua.ORDER_NONE)||"''";if("SPLIT"==(e=e.getFieldValue("MODE")))a=a||"''",e=E.Lua.provideFunction_("list_string_split",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(input, delim)","  local t = {}","  local pos = 1","  while true do","    next_delim = string.find(input, delim, pos)","    if next_delim == nil then","      table.insert(t, string.sub(input, pos))","      break","    else","      table.insert(t, string.sub(input, pos, next_delim-1))","      pos = next_delim + #delim","    end","  end","  return t","end"]);else{if("JOIN"!=e)throw Error("Unknown mode: "+e);a=a||"{}",e="table.concat"}return[e+"("+a+", "+t+")",E.Lua.ORDER_HIGH]},E.Lua.lists_reverse=function(e){return e=E.Lua.valueToCode(e,"LIST",E.Lua.ORDER_NONE)||"{}",[E.Lua.provideFunction_("list_reverse",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(input)","  local reversed = {}","  for i = #input, 1, -1 do","    table.insert(reversed, input[i])","  end","  return reversed","end"])+"("+e+")",E.Lua.ORDER_HIGH]},E.Lua.logic={},E.Lua.controls_if=function(e){var a=0,t="";E.Lua.STATEMENT_PREFIX&&(t+=E.Lua.injectId(E.Lua.STATEMENT_PREFIX,e));do{var u=E.Lua.valueToCode(e,"IF"+a,E.Lua.ORDER_NONE)||"false",n=E.Lua.statementToCode(e,"DO"+a)}while(E.Lua.STATEMENT_SUFFIX&&(n=E.Lua.prefixLines(E.Lua.injectId(E.Lua.STATEMENT_SUFFIX,e),E.Lua.INDENT)+n),t+=(0<a?"else":"")+"if "+u+" then\n"+n,++a,e.getInput("IF"+a));return(e.getInput("ELSE")||E.Lua.STATEMENT_SUFFIX)&&(n=E.Lua.statementToCode(e,"ELSE"),E.Lua.STATEMENT_SUFFIX&&(n=E.Lua.prefixLines(E.Lua.injectId(E.Lua.STATEMENT_SUFFIX,e),E.Lua.INDENT)+n),t+="else\n"+n),t+"end\n"},E.Lua.controls_ifelse=E.Lua.controls_if,E.Lua.logic_compare=function(e){var a={EQ:"==",NEQ:"~=",LT:"<",LTE:"<=",GT:">",GTE:">="}[e.getFieldValue("OP")];return[(E.Lua.valueToCode(e,"A",E.Lua.ORDER_RELATIONAL)||"0")+" "+a+" "+(e=E.Lua.valueToCode(e,"B",E.Lua.ORDER_RELATIONAL)||"0"),E.Lua.ORDER_RELATIONAL]},E.Lua.logic_operation=function(e){var a,t="AND"==e.getFieldValue("OP")?"and":"or",u="and"==t?E.Lua.ORDER_AND:E.Lua.ORDER_OR,n=E.Lua.valueToCode(e,"A",u);return e=E.Lua.valueToCode(e,"B",u),e=n||e?(a="and"==t?"true":"false",n=n||a,e||a):n="false",[n+" "+t+" "+e,u]},E.Lua.logic_negate=function(e){return["not "+(E.Lua.valueToCode(e,"BOOL",E.Lua.ORDER_UNARY)||"true"),E.Lua.ORDER_UNARY]},E.Lua.logic_boolean=function(e){return["TRUE"==e.getFieldValue("BOOL")?"true":"false",E.Lua.ORDER_ATOMIC]},E.Lua.logic_null=function(e){return["nil",E.Lua.ORDER_ATOMIC]},E.Lua.logic_ternary=function(e){return[(E.Lua.valueToCode(e,"IF",E.Lua.ORDER_AND)||"false")+" and "+(E.Lua.valueToCode(e,"THEN",E.Lua.ORDER_AND)||"nil")+" or "+(e=E.Lua.valueToCode(e,"ELSE",E.Lua.ORDER_OR)||"nil"),E.Lua.ORDER_OR]},E.Lua.loops={},E.Lua.CONTINUE_STATEMENT="goto continue\n",E.Lua.addContinueLabel_=function(e){return-1!=e.indexOf(E.Lua.CONTINUE_STATEMENT)?e+E.Lua.INDENT+"::continue::\n":e},E.Lua.controls_repeat_ext=function(e){var a=e.getField("TIMES")?String(Number(e.getFieldValue("TIMES"))):E.Lua.valueToCode(e,"TIMES",E.Lua.ORDER_NONE)||"0",a=E.isNumber(a)?parseInt(a,10):"math.floor("+a+")",t=E.Lua.statementToCode(e,"DO"),t=E.Lua.addLoopTrap(t,e);return t=E.Lua.addContinueLabel_(t),"for "+E.Lua.variableDB_.getDistinctName("count",E.VARIABLE_CATEGORY_NAME)+" = 1, "+a+" do\n"+t+"end\n"},E.Lua.controls_repeat=E.Lua.controls_repeat_ext,E.Lua.controls_whileUntil=function(e){var a="UNTIL"==e.getFieldValue("MODE"),t=E.Lua.valueToCode(e,"BOOL",a?E.Lua.ORDER_UNARY:E.Lua.ORDER_NONE)||"false",u=E.Lua.statementToCode(e,"DO"),u=E.Lua.addLoopTrap(u,e);return a&&(t="not "+t),"while "+t+" do\n"+E.Lua.addContinueLabel_(u)+"end\n"},E.Lua.controls_for=function(e){var a,t=E.Lua.variableDB_.getName(e.getFieldValue("VAR"),E.VARIABLE_CATEGORY_NAME),u=E.Lua.valueToCode(e,"FROM",E.Lua.ORDER_NONE)||"0",n=E.Lua.valueToCode(e,"TO",E.Lua.ORDER_NONE)||"0",r=E.Lua.valueToCode(e,"BY",E.Lua.ORDER_NONE)||"1",o=E.Lua.statementToCode(e,"DO"),o=E.Lua.addLoopTrap(o,e);return o=E.Lua.addContinueLabel_(o),e="",E.isNumber(u)&&E.isNumber(n)&&E.isNumber(r)?a=(Number(u)<=Number(n)?"":"-")+Math.abs(Number(r)):(e="",e+=(a=E.Lua.variableDB_.getDistinctName(t+"_inc",E.VARIABLE_CATEGORY_NAME))+" = ",e=(e=E.isNumber(r)?e+(Math.abs(r)+"\n"):e+"math.abs("+r+")\n")+"if ("+u+") > ("+n+") then\n"+(E.Lua.INDENT+a)+" = -"+a+"\n",e+="end\n"),e+"for "+t+" = "+u+", "+n+", "+a+" do\n"+o+"end\n"},E.Lua.controls_forEach=function(e){var a=E.Lua.variableDB_.getName(e.getFieldValue("VAR"),E.VARIABLE_CATEGORY_NAME),t=E.Lua.valueToCode(e,"LIST",E.Lua.ORDER_NONE)||"{}",u=E.Lua.statementToCode(e,"DO"),u=E.Lua.addLoopTrap(u,e);return"for _, "+a+" in ipairs("+t+") do \n"+E.Lua.addContinueLabel_(u)+"end\n"},E.Lua.controls_flow_statements=function(e){var a,t="";switch(E.Lua.STATEMENT_PREFIX&&(t+=E.Lua.injectId(E.Lua.STATEMENT_PREFIX,e)),E.Lua.STATEMENT_SUFFIX&&(t+=E.Lua.injectId(E.Lua.STATEMENT_SUFFIX,e)),!E.Lua.STATEMENT_PREFIX||(a=E.Constants.Loops.CONTROL_FLOW_IN_LOOP_CHECK_MIXIN.getSurroundLoop(e))&&!a.suppressPrefixSuffix&&(t+=E.Lua.injectId(E.Lua.STATEMENT_PREFIX,a)),e.getFieldValue("FLOW")){case"BREAK":return t+"break\n";case"CONTINUE":return t+E.Lua.CONTINUE_STATEMENT}throw Error("Unknown flow statement.")},E.Lua.math={},E.Lua.math_number=function(e){return[e=Number(e.getFieldValue("NUM")),e<0?E.Lua.ORDER_UNARY:E.Lua.ORDER_ATOMIC]},E.Lua.math_arithmetic=function(e){var a=(t={ADD:[" + ",E.Lua.ORDER_ADDITIVE],MINUS:[" - ",E.Lua.ORDER_ADDITIVE],MULTIPLY:[" * ",E.Lua.ORDER_MULTIPLICATIVE],DIVIDE:[" / ",E.Lua.ORDER_MULTIPLICATIVE],POWER:[" ^ ",E.Lua.ORDER_EXPONENTIATION]}[e.getFieldValue("OP")])[0],t=t[1];return[(E.Lua.valueToCode(e,"A",t)||"0")+a+(e=E.Lua.valueToCode(e,"B",t)||"0"),t]},E.Lua.math_single=function(e){var a=e.getFieldValue("OP");if("NEG"==a)return["-"+(e=E.Lua.valueToCode(e,"NUM",E.Lua.ORDER_UNARY)||"0"),E.Lua.ORDER_UNARY];if("POW10"==a)return["10 ^ "+(e=E.Lua.valueToCode(e,"NUM",E.Lua.ORDER_EXPONENTIATION)||"0"),E.Lua.ORDER_EXPONENTIATION];switch(e="ROUND"==a?E.Lua.valueToCode(e,"NUM",E.Lua.ORDER_ADDITIVE)||"0":E.Lua.valueToCode(e,"NUM",E.Lua.ORDER_NONE)||"0",a){case"ABS":a="math.abs("+e+")";break;case"ROOT":a="math.sqrt("+e+")";break;case"LN":a="math.log("+e+")";break;case"LOG10":a="math.log("+e+", 10)";break;case"EXP":a="math.exp("+e+")";break;case"ROUND":a="math.floor("+e+" + .5)";break;case"ROUNDUP":a="math.ceil("+e+")";break;case"ROUNDDOWN":a="math.floor("+e+")";break;case"SIN":a="math.sin(math.rad("+e+"))";break;case"COS":a="math.cos(math.rad("+e+"))";break;case"TAN":a="math.tan(math.rad("+e+"))";break;case"ASIN":a="math.deg(math.asin("+e+"))";break;case"ACOS":a="math.deg(math.acos("+e+"))";break;case"ATAN":a="math.deg(math.atan("+e+"))";break;default:throw Error("Unknown math operator: "+a)}return[a,E.Lua.ORDER_HIGH]},E.Lua.math_constant=function(e){return{PI:["math.pi",E.Lua.ORDER_HIGH],E:["math.exp(1)",E.Lua.ORDER_HIGH],GOLDEN_RATIO:["(1 + math.sqrt(5)) / 2",E.Lua.ORDER_MULTIPLICATIVE],SQRT2:["math.sqrt(2)",E.Lua.ORDER_HIGH],SQRT1_2:["math.sqrt(1 / 2)",E.Lua.ORDER_HIGH],INFINITY:["math.huge",E.Lua.ORDER_HIGH]}[e.getFieldValue("CONSTANT")]},E.Lua.math_number_property=function(e){var a=E.Lua.valueToCode(e,"NUMBER_TO_CHECK",E.Lua.ORDER_MULTIPLICATIVE)||"0",t=e.getFieldValue("PROPERTY");if("PRIME"==t)return[E.Lua.provideFunction_("math_isPrime",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(n)","  -- https://en.wikipedia.org/wiki/Primality_test#Naive_methods","  if n == 2 or n == 3 then","    return true","  end","  -- False if n is NaN, negative, is 1, or not whole.","  -- And false if n is divisible by 2 or 3.","  if not(n > 1) or n % 1 ~= 0 or n % 2 == 0 or n % 3 == 0 then","    return false","  end","  -- Check all the numbers of form 6k +/- 1, up to sqrt(n).","  for x = 6, math.sqrt(n) + 1.5, 6 do","    if n % (x - 1) == 0 or n % (x + 1) == 0 then","      return false","    end","  end","  return true","end"])+"("+a+")",E.Lua.ORDER_HIGH];switch(t){case"EVEN":var u=a+" % 2 == 0";break;case"ODD":u=a+" % 2 == 1";break;case"WHOLE":u=a+" % 1 == 0";break;case"POSITIVE":u=a+" > 0";break;case"NEGATIVE":u=a+" < 0";break;case"DIVISIBLE_BY":if(!(e=E.Lua.valueToCode(e,"DIVISOR",E.Lua.ORDER_MULTIPLICATIVE))||"0"==e)return["nil",E.Lua.ORDER_ATOMIC];u=a+" % "+e+" == 0"}return[u,E.Lua.ORDER_RELATIONAL]},E.Lua.math_change=function(e){var a=E.Lua.valueToCode(e,"DELTA",E.Lua.ORDER_ADDITIVE)||"0";return(e=E.Lua.variableDB_.getName(e.getFieldValue("VAR"),E.VARIABLE_CATEGORY_NAME))+" = "+e+" + "+a+"\n"},E.Lua.math_round=E.Lua.math_single,E.Lua.math_trig=E.Lua.math_single,E.Lua.math_on_list=function(e){function a(){return E.Lua.provideFunction_("math_sum",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  local result = 0","  for _, v in ipairs(t) do","    result = result + v","  end","  return result","end"])}var t=e.getFieldValue("OP");switch(e=E.Lua.valueToCode(e,"LIST",E.Lua.ORDER_NONE)||"{}",t){case"SUM":t=a();break;case"MIN":t=E.Lua.provideFunction_("math_min",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return 0","  end","  local result = math.huge","  for _, v in ipairs(t) do","    if v < result then","      result = v","    end","  end","  return result","end"]);break;case"AVERAGE":t=E.Lua.provideFunction_("math_average",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return 0","  end","  return "+a()+"(t) / #t","end"]);break;case"MAX":t=E.Lua.provideFunction_("math_max",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return 0","  end","  local result = -math.huge","  for _, v in ipairs(t) do","    if v > result then","      result = v","    end","  end","  return result","end"]);break;case"MEDIAN":t=E.Lua.provideFunction_("math_median",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  -- Source: http://lua-users.org/wiki/SimpleStats","  if #t == 0 then","    return 0","  end","  local temp={}","  for _, v in ipairs(t) do",'    if type(v) == "number" then',"      table.insert(temp, v)","    end","  end","  table.sort(temp)","  if #temp % 2 == 0 then","    return (temp[#temp/2] + temp[(#temp/2)+1]) / 2","  else","    return temp[math.ceil(#temp/2)]","  end","end"]);break;case"MODE":t=E.Lua.provideFunction_("math_modes",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  -- Source: http://lua-users.org/wiki/SimpleStats","  local counts={}","  for _, v in ipairs(t) do","    if counts[v] == nil then","      counts[v] = 1","    else","      counts[v] = counts[v] + 1","    end","  end","  local biggestCount = 0","  for _, v  in pairs(counts) do","    if v > biggestCount then","      biggestCount = v","    end","  end","  local temp={}","  for k, v in pairs(counts) do","    if v == biggestCount then","      table.insert(temp, k)","    end","  end","  return temp","end"]);break;case"STD_DEV":t=E.Lua.provideFunction_("math_standard_deviation",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  local m","  local vm","  local total = 0","  local count = 0","  local result","  m = #t == 0 and 0 or "+a()+"(t) / #t","  for _, v in ipairs(t) do","    if type(v) == 'number' then","      vm = v - m","      total = total + (vm * vm)","      count = count + 1","    end","  end","  result = math.sqrt(total / (count-1))","  return result","end"]);break;case"RANDOM":t=E.Lua.provideFunction_("math_random_list",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(t)","  if #t == 0 then","    return nil","  end","  return t[math.random(#t)]","end"]);break;default:throw Error("Unknown operator: "+t)}return[t+"("+e+")",E.Lua.ORDER_HIGH]},E.Lua.math_modulo=function(e){return[(E.Lua.valueToCode(e,"DIVIDEND",E.Lua.ORDER_MULTIPLICATIVE)||"0")+" % "+(e=E.Lua.valueToCode(e,"DIVISOR",E.Lua.ORDER_MULTIPLICATIVE)||"0"),E.Lua.ORDER_MULTIPLICATIVE]},E.Lua.math_constrain=function(e){return["math.min(math.max("+(E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_NONE)||"0")+", "+(E.Lua.valueToCode(e,"LOW",E.Lua.ORDER_NONE)||"-math.huge")+"), "+(e=E.Lua.valueToCode(e,"HIGH",E.Lua.ORDER_NONE)||"math.huge")+")",E.Lua.ORDER_HIGH]},E.Lua.math_random_int=function(e){return["math.random("+(E.Lua.valueToCode(e,"FROM",E.Lua.ORDER_NONE)||"0")+", "+(e=E.Lua.valueToCode(e,"TO",E.Lua.ORDER_NONE)||"0")+")",E.Lua.ORDER_HIGH]},E.Lua.math_random_float=function(e){return["math.random()",E.Lua.ORDER_HIGH]},E.Lua.math_atan2=function(e){var a=E.Lua.valueToCode(e,"X",E.Lua.ORDER_NONE)||"0";return["math.deg(math.atan2("+(E.Lua.valueToCode(e,"Y",E.Lua.ORDER_NONE)||"0")+", "+a+"))",E.Lua.ORDER_HIGH]},E.Lua.procedures={},E.Lua.procedures_defreturn=function(e){var a=E.Lua.variableDB_.getName(e.getFieldValue("NAME"),E.PROCEDURE_CATEGORY_NAME),t="";E.Lua.STATEMENT_PREFIX&&(t+=E.Lua.injectId(E.Lua.STATEMENT_PREFIX,e)),E.Lua.STATEMENT_SUFFIX&&(t+=E.Lua.injectId(E.Lua.STATEMENT_SUFFIX,e)),t=t&&E.Lua.prefixLines(t,E.Lua.INDENT);var u="";E.Lua.INFINITE_LOOP_TRAP&&(u=E.Lua.prefixLines(E.Lua.injectId(E.Lua.INFINITE_LOOP_TRAP,e),E.Lua.INDENT));var n=E.Lua.statementToCode(e,"STACK"),r=E.Lua.valueToCode(e,"RETURN",E.Lua.ORDER_NONE)||"",o=n&&r?t:"";r?r=E.Lua.INDENT+"return "+r+"\n":n=n||"";for(var i=[],L=e.getVars(),l=0;l<L.length;l++)i[l]=E.Lua.variableDB_.getName(L[l],E.VARIABLE_CATEGORY_NAME);return t="function "+a+"("+i.join(", ")+")\n"+t+u+n+o+r+"end\n",t=E.Lua.scrub_(e,t),E.Lua.definitions_["%"+a]=t,null},E.Lua.procedures_defnoreturn=E.Lua.procedures_defreturn,E.Lua.procedures_callreturn=function(e){for(var a=E.Lua.variableDB_.getName(e.getFieldValue("NAME"),E.PROCEDURE_CATEGORY_NAME),t=[],u=e.getVars(),n=0;n<u.length;n++)t[n]=E.Lua.valueToCode(e,"ARG"+n,E.Lua.ORDER_NONE)||"nil";return[a+"("+t.join(", ")+")",E.Lua.ORDER_HIGH]},E.Lua.procedures_callnoreturn=function(e){return E.Lua.procedures_callreturn(e)[0]+"\n"},E.Lua.procedures_ifreturn=function(e){var a="if "+(E.Lua.valueToCode(e,"CONDITION",E.Lua.ORDER_NONE)||"false")+" then\n";return E.Lua.STATEMENT_SUFFIX&&(a+=E.Lua.prefixLines(E.Lua.injectId(E.Lua.STATEMENT_SUFFIX,e),E.Lua.INDENT)),e.hasReturnValue_?(e=E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_NONE)||"nil",a+=E.Lua.INDENT+"return "+e+"\n"):a+=E.Lua.INDENT+"return\n",a+"end\n"},E.Lua.texts={},E.Lua.text=function(e){return[E.Lua.quote_(e.getFieldValue("TEXT")),E.Lua.ORDER_ATOMIC]},E.Lua.text_multiline=function(e){var a=-1!=(e=E.Lua.multiline_quote_(e.getFieldValue("TEXT"))).indexOf("..")?E.Lua.ORDER_CONCATENATION:E.Lua.ORDER_ATOMIC;return[e,a]},E.Lua.text_join=function(e){if(0==e.itemCount_)return["''",E.Lua.ORDER_ATOMIC];if(1==e.itemCount_)return["tostring("+(E.Lua.valueToCode(e,"ADD0",E.Lua.ORDER_NONE)||"''")+")",E.Lua.ORDER_HIGH];if(2==e.itemCount_){var a=E.Lua.valueToCode(e,"ADD0",E.Lua.ORDER_CONCATENATION)||"''";return[a+" .. "+(e=E.Lua.valueToCode(e,"ADD1",E.Lua.ORDER_CONCATENATION)||"''"),E.Lua.ORDER_CONCATENATION]}a=[];for(var t=0;t<e.itemCount_;t++)a[t]=E.Lua.valueToCode(e,"ADD"+t,E.Lua.ORDER_NONE)||"''";return[e="table.concat({"+a.join(", ")+"})",E.Lua.ORDER_HIGH]},E.Lua.text_append=function(e){var a=E.Lua.variableDB_.getName(e.getFieldValue("VAR"),E.VARIABLE_CATEGORY_NAME);return a+" = "+a+" .. "+(e=E.Lua.valueToCode(e,"TEXT",E.Lua.ORDER_CONCATENATION)||"''")+"\n"},E.Lua.text_length=function(e){return["#"+(E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_UNARY)||"''"),E.Lua.ORDER_UNARY]},E.Lua.text_isEmpty=function(e){return["#"+(E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_UNARY)||"''")+" == 0",E.Lua.ORDER_RELATIONAL]},E.Lua.text_indexOf=function(e){var a=E.Lua.valueToCode(e,"FIND",E.Lua.ORDER_NONE)||"''",t=E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_NONE)||"''";return[("FIRST"==e.getFieldValue("END")?E.Lua.provideFunction_("firstIndexOf",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, substr) ","  local i = string.find(str, substr, 1, true)","  if i == nil then","    return 0","  else","    return i","  end","end"]):E.Lua.provideFunction_("lastIndexOf",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, substr)","  local i = string.find(string.reverse(str), string.reverse(substr), 1, true)","  if i then","    return #str + 2 - i - #substr","  end","  return 0","end"]))+"("+t+", "+a+")",E.Lua.ORDER_HIGH]},E.Lua.text_charAt=function(e){var a=e.getFieldValue("WHERE")||"FROM_START",t=E.Lua.valueToCode(e,"AT","FROM_END"==a?E.Lua.ORDER_UNARY:E.Lua.ORDER_NONE)||"1";if(e=E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_NONE)||"''","RANDOM"==a)e=(a=E.Lua.provideFunction_("text_random_letter",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str)","  local index = math.random(string.len(str))","  return string.sub(str, index, index)","end"]))+"("+e+")";else{if("FIRST"==a)t="1";else if("LAST"==a)t="-1";else if("FROM_START"!=a){if("FROM_END"!=a)throw Error("Unhandled option (text_charAt).");t="-"+t}e=t.match(/^-?\w*$/)?"string.sub("+e+", "+t+", "+t+")":(a=E.Lua.provideFunction_("text_char_at",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str, index)","  return string.sub(str, index, index)","end"]))+"("+e+", "+t+")"}return[e,E.Lua.ORDER_HIGH]},E.Lua.text_getSubstring=function(e){var a=E.Lua.valueToCode(e,"STRING",E.Lua.ORDER_NONE)||"''",t=e.getFieldValue("WHERE1"),u=E.Lua.valueToCode(e,"AT1","FROM_END"==t?E.Lua.ORDER_UNARY:E.Lua.ORDER_NONE)||"1";if("FIRST"==t)t=1;else if("FROM_START"==t)t=u;else{if("FROM_END"!=t)throw Error("Unhandled option (text_getSubstring)");t="-"+u}if(u=e.getFieldValue("WHERE2"),e=E.Lua.valueToCode(e,"AT2","FROM_END"==u?E.Lua.ORDER_UNARY:E.Lua.ORDER_NONE)||"1","LAST"==u)e=-1;else if("FROM_START"!=u){if("FROM_END"!=u)throw Error("Unhandled option (text_getSubstring)");e="-"+e}return["string.sub("+a+", "+t+", "+e+")",E.Lua.ORDER_HIGH]},E.Lua.text_changeCase=function(e){var a,t=e.getFieldValue("CASE");return e=E.Lua.valueToCode(e,"TEXT",E.Lua.ORDER_NONE)||"''","UPPERCASE"==t?a="string.upper":"LOWERCASE"==t?a="string.lower":"TITLECASE"==t&&(a=E.Lua.provideFunction_("text_titlecase",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(str)","  local buf = {}","  local inWord = false","  for i = 1, #str do","    local c = string.sub(str, i, i)","    if inWord then","      table.insert(buf, string.lower(c))",'      if string.find(c, "%s") then',"        inWord = false","      end","    else","      table.insert(buf, string.upper(c))","      inWord = true","    end","  end","  return table.concat(buf)","end"])),[a+"("+e+")",E.Lua.ORDER_HIGH]},E.Lua.text_trim=function(e){var a={LEFT:"^%s*(,-)",RIGHT:"(.-)%s*$",BOTH:"^%s*(.-)%s*$"}[e.getFieldValue("MODE")];return["string.gsub("+(E.Lua.valueToCode(e,"TEXT",E.Lua.ORDER_NONE)||"''")+', "'+a+'", "%1")',E.Lua.ORDER_HIGH]},E.Lua.text_print=function(e){return"print("+(E.Lua.valueToCode(e,"TEXT",E.Lua.ORDER_NONE)||"''")+")\n"},E.Lua.text_prompt_ext=function(e){var a=e.getField("TEXT")?E.Lua.quote_(e.getFieldValue("TEXT")):E.Lua.valueToCode(e,"TEXT",E.Lua.ORDER_NONE)||"''",a=E.Lua.provideFunction_("text_prompt",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(msg)","  io.write(msg)","  io.flush()","  return io.read()","end"])+"("+a+")";return"NUMBER"==e.getFieldValue("TYPE")&&(a="tonumber("+a+", 10)"),[a,E.Lua.ORDER_HIGH]},E.Lua.text_prompt=E.Lua.text_prompt_ext,E.Lua.text_count=function(e){var a=E.Lua.valueToCode(e,"TEXT",E.Lua.ORDER_NONE)||"''";return e=E.Lua.valueToCode(e,"SUB",E.Lua.ORDER_NONE)||"''",[E.Lua.provideFunction_("text_count",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(haystack, needle)","  if #needle == 0 then","    return #haystack + 1","  end","  local i = 1","  local count = 0","  while true do","    i = string.find(haystack, needle, i, true)","    if i == nil then","      break","    end","    count = count + 1","    i = i + #needle","  end","  return count","end"])+"("+a+", "+e+")",E.Lua.ORDER_HIGH]},E.Lua.text_replace=function(e){var a=E.Lua.valueToCode(e,"TEXT",E.Lua.ORDER_NONE)||"''",t=E.Lua.valueToCode(e,"FROM",E.Lua.ORDER_NONE)||"''";return e=E.Lua.valueToCode(e,"TO",E.Lua.ORDER_NONE)||"''",[E.Lua.provideFunction_("text_replace",["function "+E.Lua.FUNCTION_NAME_PLACEHOLDER_+"(haystack, needle, replacement)","  local buf = {}","  local i = 1","  while i <= #haystack do","    if string.sub(haystack, i, i + #needle - 1) == needle then","      for j = 1, #replacement do","        table.insert(buf, string.sub(replacement, j, j))","      end","      i = i + #needle","    else","      table.insert(buf, string.sub(haystack, i, i))","      i = i + 1","    end","  end","  return table.concat(buf)","end"])+"("+a+", "+t+", "+e+")",E.Lua.ORDER_HIGH]},E.Lua.text_reverse=function(e){return["string.reverse("+(E.Lua.valueToCode(e,"TEXT",E.Lua.ORDER_NONE)||"''")+")",E.Lua.ORDER_HIGH]},E.Lua.variables={},E.Lua.variables_get=function(e){return[E.Lua.variableDB_.getName(e.getFieldValue("VAR"),E.VARIABLE_CATEGORY_NAME),E.Lua.ORDER_ATOMIC]},E.Lua.variables_set=function(e){var a=E.Lua.valueToCode(e,"VALUE",E.Lua.ORDER_NONE)||"0";return E.Lua.variableDB_.getName(e.getFieldValue("VAR"),E.VARIABLE_CATEGORY_NAME)+" = "+a+"\n"},E.Lua.variablesDynamic={},E.Lua.variables_get_dynamic=E.Lua.variables_get,E.Lua.variables_set_dynamic=E.Lua.variables_set,E.Lua});