import*as React from"react";import PropTypes from"prop-types";import{exactProp,elementAcceptingRef}from"@material-ui/utils";import ownerDocument from"../utils/ownerDocument";import useForkRef from"../utils/useForkRef";const candidatesSelector=["input","select","textarea","a[href]","button","[tabindex]","audio[controls]","video[controls]",'[contenteditable]:not([contenteditable="false"])'].join(",");function getTabIndex(e){const t=parseInt(e.getAttribute("tabindex"),10);return Number.isNaN(t)?"true"===e.contentEditable||("AUDIO"===e.nodeName||"VIDEO"===e.nodeName||"DETAILS"===e.nodeName)&&null===e.getAttribute("tabindex")?0:e.tabIndex:t}function isNonTabbableRadio(e){if("INPUT"!==e.tagName||"radio"!==e.type)return!1;if(!e.name)return!1;const t=t=>e.ownerDocument.querySelector(`input[type="radio"]${t}`);let n=t(`[name="${e.name}"]:checked`);return n||(n=t(`[name="${e.name}"]`)),n!==e}function isNodeMatchingSelectorFocusable(e){return!(e.disabled||"INPUT"===e.tagName&&"hidden"===e.type||isNonTabbableRadio(e))}export function defaultGetTabbable(e){const t=[],n=[];return Array.from(e.querySelectorAll(candidatesSelector)).forEach((e,r)=>{const o=getTabIndex(e);-1!==o&&isNodeMatchingSelectorFocusable(e)&&(0===o?t.push(e):n.push({documentOrder:r,tabIndex:o,node:e}))}),n.sort((e,t)=>e.tabIndex===t.tabIndex?e.documentOrder-t.documentOrder:e.tabIndex-t.tabIndex).map(e=>e.node).concat(t)};function Unstable_TrapFocus(e){const{children:t,disableAutoFocus:n=!1,disableEnforceFocus:r=!1,disableRestoreFocus:o=!1,getDoc:c,getTabbable:u=defaultGetTabbable,isEnabled:a,open:s}=e,i=React.useRef(),l=React.useRef(null),d=React.useRef(null),f=React.useRef(),b=React.useRef(null),p=React.useRef(!1),m=React.useRef(null),R=useForkRef(t.ref,m),E=React.useRef(null),T=React.useRef();React.useEffect(()=>{T.current=s},[s]),T.current||!s||"undefined"==typeof window||n||(f.current=c().activeElement),React.useEffect(()=>{s&&m.current&&(p.current=!n)},[n,s]),React.useEffect(()=>{if(!s||!m.current)return;const e=ownerDocument(m.current);return m.current.contains(e.activeElement)||(m.current.hasAttribute("tabIndex")||("production"!==process.env.NODE_ENV&&console.error(["Material-UI: The modal content node does not accept focus.",'For the benefit of assistive technologies, the tabIndex of the node is being set to "-1".'].join("\n")),m.current.setAttribute("tabIndex",-1)),p.current&&m.current.focus()),()=>{o||(f.current&&f.current.focus&&(i.current=!0,f.current.focus()),f.current=null)}},[s]),React.useEffect(()=>{if(!s||!m.current)return;const e=ownerDocument(m.current),t=t=>{const{current:n}=m;if(null!==n)if(e.hasFocus()&&!r&&a()&&!i.current){if(!n.contains(e.activeElement)){if(t&&b.current!==t.target||e.activeElement!==b.current)b.current=null;else if(null!==b.current)return;if(!p.current)return;let r=[];if(e.activeElement!==l.current&&e.activeElement!==d.current||(r=u(m.current)),r.length>0){var o,c;const e=Boolean((null===(o=E.current)||void 0===o?void 0:o.shiftKey)&&"Tab"===(null===(c=E.current)||void 0===c?void 0:c.key)),t=r[0],n=r[r.length-1];e?n.focus():t.focus()}else n.focus()}}else i.current=!1},n=t=>{E.current=t,!r&&a()&&"Tab"===t.key&&e.activeElement===m.current&&t.shiftKey&&(i.current=!0,d.current.focus())};e.addEventListener("focusin",t),e.addEventListener("keydown",n,!0);const o=setInterval(()=>{"BODY"===e.activeElement.tagName&&t()},50);return()=>{clearInterval(o),e.removeEventListener("focusin",t),e.removeEventListener("keydown",n,!0)}},[n,r,o,a,s,u]);const v=e=>{p.current||(f.current=e.relatedTarget),p.current=!0};return React.createElement(React.Fragment,null,React.createElement("div",{tabIndex:0,onFocus:v,ref:l,"data-test":"sentinelStart"}),React.cloneElement(t,{ref:R,onFocus:e=>{p.current||(f.current=e.relatedTarget),p.current=!0,b.current=e.target;const n=t.props.onFocus;n&&n(e)}}),React.createElement("div",{tabIndex:0,onFocus:v,ref:d,"data-test":"sentinelEnd"}))}"production"!==process.env.NODE_ENV&&(Unstable_TrapFocus.propTypes={children:elementAcceptingRef,disableAutoFocus:PropTypes.bool,disableEnforceFocus:PropTypes.bool,disableRestoreFocus:PropTypes.bool,getDoc:PropTypes.func.isRequired,getTabbable:PropTypes.func,isEnabled:PropTypes.func.isRequired,open:PropTypes.bool.isRequired}),"production"!==process.env.NODE_ENV&&(Unstable_TrapFocus.propTypes=exactProp(Unstable_TrapFocus.propTypes));export default Unstable_TrapFocus;