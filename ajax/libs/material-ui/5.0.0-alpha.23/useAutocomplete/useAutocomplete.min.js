import _extends from"@babel/runtime/helpers/esm/extends";import*as React from"react";import{setRef,useEventCallback,useControlled,unstable_useId as useId}from"../utils";function stripDiacritics(e){return void 0!==e.normalize?e.normalize("NFD").replace(/[\u0300-\u036f]/g,""):e}export function createFilterOptions(e={}){const{ignoreAccents:t=!0,ignoreCase:n=!0,limit:r,matchFrom:o="any",stringify:i,trim:l=!1}=e;return(e,{inputValue:a,getOptionLabel:s})=>{let u=l?a.trim():a;n&&(u=u.toLowerCase()),t&&(u=stripDiacritics(u));const c=e.filter(e=>{let r=(i||s)(e);return n&&(r=r.toLowerCase()),t&&(r=stripDiacritics(r)),"start"===o?0===r.indexOf(u):r.indexOf(u)>-1});return"number"==typeof r?c.slice(0,r):c}};function findIndex(e,t){for(let n=0;n<e.length;n+=1)if(t(e[n]))return n;return-1}const defaultFilterOptions=createFilterOptions(),pageSize=5;export default function useAutocomplete(e){const{autoComplete:t=!1,autoHighlight:n=!1,autoSelect:r=!1,blurOnSelect:o=!1,clearOnBlur:i=!e.freeSolo,clearOnEscape:l=!1,componentName:a="useAutocomplete",defaultValue:s=(e.multiple?[]:null),disableClearable:u=!1,disableCloseOnSelect:c=!1,disabledItemsFocusable:d=!1,disableListWrap:p=!1,filterOptions:f=defaultFilterOptions,filterSelectedOptions:g=!1,freeSolo:h=!1,getOptionDisabled:b,getOptionLabel:v=(e=>{var t;return null!==(t=e.label)&&void 0!==t?t:e}),getOptionSelected:m=((e,t)=>e===t),groupBy:x,handleHomeEndKeys:y=!e.freeSolo,id:O,includeInputInList:k=!1,inputValue:S,multiple:C=!1,onChange:D,onClose:E,onHighlightChange:R,onInputChange:w,onOpen:I,open:A,openOnFocus:$=!1,options:T,selectOnFocus:L=!e.freeSolo,value:N}=e,M=useId(O);let P=v;P=(e=>{const t=v(e);if("string"!=typeof t){if("production"!==process.env.NODE_ENV){const n=void 0===t?"undefined":`${typeof t} (${t})`;console.error(`Material-UI: The \`getOptionLabel\` method of ${a} returned ${n} instead of a string for ${JSON.stringify(e)}.`)}return String(t)}return t});const V=React.useRef(!1),F=React.useRef(!0),H=React.useRef(null),q=React.useRef(null),[z,_]=React.useState(null),[B,K]=React.useState(-1),U=n?0:-1,J=React.useRef(U),[j,Y]=useControlled({controlled:N,default:s,name:a}),[W,G]=useControlled({controlled:S,default:"",name:a,state:"inputValue"}),[Q,X]=React.useState(!1),Z=useEventCallback((e,t)=>{let n;if(C)n="";else if(null==t)n="";else{const e=P(t);n="string"==typeof e?e:""}W!==n&&(G(n),w&&w(e,n,"reset"))});React.useEffect(()=>{Z(null,j)},[j,Z]);const[ee,te]=useControlled({controlled:A,default:!1,name:a,state:"open"}),[ne,re]=React.useState(!0),oe=!C&&null!=j&&W===P(j),ie=ee,le=ie?f(T.filter(e=>!g||!(C?j:[j]).some(t=>null!==t&&m(e,t))),{inputValue:oe&&ne?"":W,getOptionLabel:P}):[],ae=ee&&le.length>0;if("production"!==process.env.NODE_ENV&&null!==j&&!h&&T.length>0){const e=(C?j:[j]).filter(e=>!T.some(t=>m(t,e)));e.length>0&&console.warn([`Material-UI: The value provided to ${a} is invalid.`,`None of the options match with \`${e.length>1?JSON.stringify(e):JSON.stringify(e[0])}\`.`,"You can use the `getOptionSelected` prop to customize the equality test."].join("\n"))}const se=useEventCallback(e=>{-1===e?H.current.focus():z.querySelector(`[data-tag-index="${e}"]`).focus()});React.useEffect(()=>{C&&B>j.length-1&&(K(-1),se(-1))},[j,C,B,se]);const ue=useEventCallback(({event:e,index:t,reason:n="auto"})=>{if(J.current=t,-1===t?H.current.removeAttribute("aria-activedescendant"):H.current.setAttribute("aria-activedescendant",`${M}-option-${t}`),R&&R(e,-1===t?null:le[t],n),!q.current)return;const r=q.current.querySelector("[data-focus]");r&&(r.removeAttribute("data-focus"),r.classList.remove("Mui-focusVisible"));const o=q.current.parentElement.querySelector('[role="listbox"]');if(!o)return;if(-1===t)return void(o.scrollTop=0);const i=q.current.querySelector(`[data-option-index="${t}"]`);if(i&&(i.setAttribute("data-focus","true"),"keyboard"===n&&i.classList.add("Mui-focusVisible"),o.scrollHeight>o.clientHeight&&"mouse"!==n)){const e=i,t=o.clientHeight+o.scrollTop,n=e.offsetTop+e.offsetHeight;n>t?o.scrollTop=n-o.clientHeight:e.offsetTop-e.offsetHeight*(x?1.3:0)<o.scrollTop&&(o.scrollTop=e.offsetTop-e.offsetHeight*(x?1.3:0))}}),ce=useEventCallback(({event:e,diff:n,direction:r="next",reason:o="auto"})=>{if(!ie)return;const i=function(e,t){if(!q.current||-1===e)return-1;let n=e;for(;;){if("next"===t&&n===le.length||"previous"===t&&-1===n)return-1;const e=q.current.querySelector(`[data-option-index="${n}"]`),r=!d&&(!e||e.disabled||"true"===e.getAttribute("aria-disabled"));if(!(e&&!e.hasAttribute("tabindex")||r))return n;n+="next"===t?1:-1}}((()=>{const e=le.length-1;if("reset"===n)return U;if("start"===n)return 0;if("end"===n)return e;const t=J.current+n;return t<0?-1===t&&k?-1:p&&-1!==J.current||Math.abs(n)>1?0:e:t>e?t===e+1&&k?-1:p||Math.abs(n)>1?e:0:t})(),r);if(ue({index:i,reason:o,event:e}),t&&"reset"!==n)if(-1===i)H.current.value=W;else{const e=P(le[i]);H.current.value=e,0===e.toLowerCase().indexOf(W.toLowerCase())&&W.length>0&&H.current.setSelectionRange(W.length,e.length)}}),de=React.useCallback(()=>{if(!ie)return;const e=C?j[0]:j;if(0!==le.length&&null!=e){if(q.current)if(null==e)J.current>=le.length-1?ue({index:le.length-1}):ue({index:J.current});else{const t=le[J.current];if(C&&t&&-1!==findIndex(j,e=>m(t,e)))return;const n=findIndex(le,t=>m(t,e));-1===n?ce({diff:"reset"}):ue({index:n})}}else ce({diff:"reset"})},[le.length,!C&&j,g,ce,ue,ie,W,C]),pe=useEventCallback(e=>{setRef(q,e),e&&de()});React.useEffect(()=>{de()},[de]);const fe=e=>{ee||(te(!0),re(!0),I&&I(e))},ge=(e,t)=>{ee&&(te(!1),E&&E(e,t))},he=(e,t,n,r)=>{j!==t&&(D&&D(e,t,n,r),Y(t))},be=React.useRef(!1),ve=(e,t,n="select-option",r="options")=>{let i=n,l=t;if(C){if(l=Array.isArray(j)?j.slice():[],"production"!==process.env.NODE_ENV){const e=l.filter(e=>m(t,e));e.length>1&&console.error([`Material-UI: The \`getOptionSelected\` method of ${a} do not handle the arguments correctly.`,`The component expects a single value to match a given option but found ${e.length} matches.`].join("\n"))}const e=findIndex(l,e=>m(t,e));-1===e?l.push(t):"freeSolo"!==r&&(l.splice(e,1),i="remove-option")}Z(e,l),he(e,l,i,{option:t}),c||e.ctrlKey||e.metaKey||ge(e,i),(!0===o||"touch"===o&&be.current||"mouse"===o&&!be.current)&&H.current.blur()};const me=(e,t)=>{if(!C)return;ge(e,"toggleInput");let n=B;-1===B?""===W&&"previous"===t&&(n=j.length-1):((n+="next"===t?1:-1)<0&&(n=0),n===j.length&&(n=-1)),n=function(e,t){if(-1===e)return-1;let n=e;for(;;){if("next"===t&&n===j.length||"previous"===t&&-1===n)return-1;const e=z.querySelector(`[data-tag-index="${n}"]`);if(e&&e.hasAttribute("tabindex")&&!e.disabled&&"true"!==e.getAttribute("aria-disabled"))return n;n+="next"===t?1:-1}}(n,t),K(n),se(n)},xe=e=>{V.current=!0,G(""),w&&w(e,"","clear"),he(e,C?[]:null,"clear")},ye=e=>{ue({event:e,index:Number(e.currentTarget.getAttribute("data-option-index")),reason:"mouse"})},Oe=()=>{be.current=!0},ke=e=>{const t=Number(e.currentTarget.getAttribute("data-option-index"));ve(e,le[t],"select-option"),be.current=!1},Se=e=>{ee?ge(e,"toggleInput"):fe(e)},Ce=e=>{e.target.getAttribute("id")!==M&&e.preventDefault()},De=()=>{H.current.focus(),L&&F.current&&H.current.selectionEnd-H.current.selectionStart==0&&H.current.select(),F.current=!1};let Ee=h&&W.length>0;Ee=Ee||(C?j.length>0:null!==j);let Re=le;if(x){const e=new Map;let t=!1;Re=le.reduce((n,r,o)=>{const i=x(r);return n.length>0&&n[n.length-1].group===i?n[n.length-1].options.push(r):("production"!==process.env.NODE_ENV&&(e.get(i)&&!t&&(console.warn(`Material-UI: The options provided combined with the \`groupBy\` method of ${a} returns duplicated headers.`,"You can solve the issue by sorting the options with the output of `groupBy`."),t=!0),e.set(i,!0)),n.push({key:o,index:o,group:i,options:[r]})),n},[])}return{getRootProps:(e={})=>_extends({"aria-owns":ae?`${M}-listbox`:null,role:"combobox","aria-expanded":ae},e,{onKeyDown:(e=>n=>{if(e.onKeyDown&&e.onKeyDown(n),!n.defaultMuiPrevented&&(-1!==B&&-1===["ArrowLeft","ArrowRight"].indexOf(n.key)&&(K(-1),se(-1)),229!==n.which))switch(n.key){case"Home":ie&&y&&(n.preventDefault(),ce({diff:"start",direction:"next",reason:"keyboard",event:n}));break;case"End":ie&&y&&(n.preventDefault(),ce({diff:"end",direction:"previous",reason:"keyboard",event:n}));break;case"PageUp":n.preventDefault(),ce({diff:-pageSize,direction:"previous",reason:"keyboard",event:n}),fe(n);break;case"PageDown":n.preventDefault(),ce({diff:pageSize,direction:"next",reason:"keyboard",event:n}),fe(n);break;case"ArrowDown":n.preventDefault(),ce({diff:1,direction:"next",reason:"keyboard",event:n}),fe(n);break;case"ArrowUp":n.preventDefault(),ce({diff:-1,direction:"previous",reason:"keyboard",event:n}),fe(n);break;case"ArrowLeft":me(n,"previous");break;case"ArrowRight":me(n,"next");break;case"Enter":if(-1!==J.current&&ie){const e=le[J.current],r=!!b&&b(e);if(n.preventDefault(),r)return;ve(n,e,"select-option"),t&&H.current.setSelectionRange(H.current.value.length,H.current.value.length)}else h&&""!==W&&!1===oe&&(C&&n.preventDefault(),ve(n,W,"create-option","freeSolo"));break;case"Escape":ie?(n.preventDefault(),n.stopPropagation(),ge(n,"escape")):l&&(""!==W||C&&j.length>0)&&(n.preventDefault(),n.stopPropagation(),xe(n));break;case"Backspace":if(C&&""===W&&j.length>0){const e=-1===B?j.length-1:B,t=j.slice();t.splice(e,1),he(n,t,"remove-option",{option:j[e]})}}})(e),onMouseDown:Ce,onClick:De}),getInputLabelProps:()=>({id:`${M}-label`,htmlFor:M}),getInputProps:()=>({id:M,value:W,onBlur:e=>{null!==q.current&&q.current.parentElement.contains(document.activeElement)?H.current.focus():(X(!1),F.current=!0,V.current=!1,r&&-1!==J.current&&ie?ve(e,le[J.current],"blur"):r&&h&&""!==W?ve(e,W,"blur","freeSolo"):i&&Z(e,j),ge(e,"blur"))},onFocus:e=>{X(!0),$&&!V.current&&fe(e)},onChange:e=>{const t=e.target.value;W!==t&&(G(t),re(!1),w&&w(e,t,"input")),""===t?u||C||he(e,null,"clear"):fe(e)},onMouseDown:e=>{""!==W&&ee||Se(e)},"aria-activedescendant":ie?"":null,"aria-autocomplete":t?"both":"list","aria-controls":ae?`${M}-listbox`:null,autoComplete:"off",ref:H,autoCapitalize:"none",spellCheck:"false"}),getClearProps:()=>({tabIndex:-1,onClick:xe}),getPopupIndicatorProps:()=>({tabIndex:-1,onClick:Se}),getTagProps:({index:e})=>({key:e,"data-tag-index":e,tabIndex:-1,onDelete:(e=>t=>{const n=j.slice();n.splice(e,1),he(t,n,"remove-option",{option:j[e]})})(e)}),getListboxProps:()=>({role:"listbox",id:`${M}-listbox`,"aria-labelledby":`${M}-label`,ref:pe,onMouseDown:e=>{e.preventDefault()}}),getOptionProps:({index:e,option:t})=>{const n=(C?j:[j]).some(e=>null!=e&&m(t,e)),r=!!b&&b(t);return{key:P(t),tabIndex:-1,role:"option",id:`${M}-option-${e}`,onMouseOver:ye,onClick:ke,onTouchStart:Oe,"data-option-index":e,"aria-disabled":r,"aria-selected":n}},id:M,inputValue:W,value:j,dirty:Ee,popupOpen:ie,focused:Q||-1!==B,anchorEl:z,setAnchorEl:_,focusedTag:B,groupedOptions:Re}};