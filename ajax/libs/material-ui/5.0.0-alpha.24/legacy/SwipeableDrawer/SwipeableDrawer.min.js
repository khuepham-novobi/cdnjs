import _objectWithoutProperties from"@babel/runtime/helpers/esm/objectWithoutProperties";import _extends from"@babel/runtime/helpers/esm/extends";import*as React from"react";import PropTypes from"prop-types";import{elementTypeAcceptingRef}from"@material-ui/utils";import{getThemeProps}from"@material-ui/styles";import Drawer,{getAnchor,isHorizontal}from"../Drawer/Drawer";import ownerDocument from"../utils/ownerDocument";import ownerWindow from"../utils/ownerWindow";import useEventCallback from"../utils/useEventCallback";import useEnhancedEffect from"../utils/useEnhancedEffect";import{duration}from"../styles/transitions";import useTheme from"../styles/useTheme";import{getTransitionProps}from"../transitions/utils";import NoSsr from"../NoSsr";import SwipeArea from"./SwipeArea";var UNCERTAINTY_THRESHOLD=3,DRAG_STARTED_SIGNAL=20,claimedSwipeInstance=null;export function reset(){claimedSwipeInstance=null};function calculateCurrentX(e,r,t){return"right"===e?t.body.offsetWidth-r[0].pageX:r[0].pageX}function calculateCurrentY(e,r,t){return"bottom"===e?t.innerHeight-r[0].clientY:r[0].clientY}function getMaxTranslate(e,r){return e?r.clientWidth:r.clientHeight}function getTranslate(e,r,t,n){return Math.min(Math.max(t?r-e:n+r-e,0),n)}function getDomTreeShapes(e,r){for(var t=[];e&&e!==r.parentElement;){var n=ownerWindow(r).getComputedStyle(e);"absolute"===n.getPropertyValue("position")||"hidden"===n.getPropertyValue("overflow-x")||(e.clientWidth>0&&e.scrollWidth>e.clientWidth||e.clientHeight>0&&e.scrollHeight>e.clientHeight)&&t.push(e),e=e.parentElement}return t}function computeHasNativeHandler(e){var r=e.domTreeShapes,t=e.start,n=e.current,a=e.anchor,o={x:"scrollLeft",y:"scrollTop"},i={x:"scrollWidth",y:"scrollHeight"},s={x:"clientWidth",y:"clientHeight"};return r.some(function(e){var r=n>=t;"top"!==a&&"left"!==a||(r=!r);var c="left"===a||"right"===a?"x":"y",u=e[o[c]],l=u>0,p=u+e[s[c]]<e[i[c]];return!!(r&&p||!r&&l)})}var iOS="undefined"!=typeof navigator&&/iPad|iPhone|iPod/.test(navigator.userAgent),transitionDurationDefault={enter:duration.enteringScreen,exit:duration.leavingScreen},SwipeableDrawer=React.forwardRef(function(e,r){var t=useTheme(),n=getThemeProps({name:"MuiSwipeableDrawer",props:_extends({},e),theme:t}),a=n.anchor,o=void 0===a?"left":a,i=n.disableBackdropTransition,s=void 0!==i&&i,c=n.disableDiscovery,u=void 0!==c&&c,l=n.disableSwipeToOpen,p=void 0===l?iOS:l,d=n.hideBackdrop,m=n.hysteresis,f=void 0===m?.52:m,T=n.minFlingVelocity,h=void 0===T?450:T,v=n.ModalProps,g=(v=void 0===v?{}:v).BackdropProps,y=_objectWithoutProperties(v,["BackdropProps"]),w=n.onClose,P=n.onOpen,S=n.open,b=n.PaperProps,R=void 0===b?{}:b,D=n.SwipeAreaProps,E=n.swipeAreaWidth,A=void 0===E?20:E,H=n.transitionDuration,x=void 0===H?transitionDurationDefault:H,_=n.variant,C=void 0===_?"temporary":_,N=_objectWithoutProperties(n,["anchor","disableBackdropTransition","disableDiscovery","disableSwipeToOpen","hideBackdrop","hysteresis","minFlingVelocity","ModalProps","onClose","onOpen","open","PaperProps","SwipeAreaProps","swipeAreaWidth","transitionDuration","variant"]),I=React.useState(!1),M=I[0],W=I[1],Y=React.useRef({isSwiping:null}),k=React.useRef(),O=React.useRef(),L=React.useRef(),X=React.useRef(!1),B=React.useRef();useEnhancedEffect(function(){B.current=null},[S]);var G=React.useCallback(function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.mode,a=void 0===n?null:n,i=r.changeTransition,c=void 0===i||i,u=getAnchor(t,o),l=-1!==["right","bottom"].indexOf(u)?1:-1,p=isHorizontal(o),m=p?"translate(".concat(l*e,"px, 0)"):"translate(0, ".concat(l*e,"px)"),f=L.current.style;f.webkitTransform=m,f.transform=m;var T="";if(a&&(T=t.transitions.create("all",getTransitionProps({timeout:x},{mode:a}))),c&&(f.webkitTransition=T,f.transition=T),!s&&!d){var h=O.current.style;h.opacity=1-e/getMaxTranslate(p,L.current),c&&(h.webkitTransition=T,h.transition=T)}},[o,s,d,t,x]),j=useEventCallback(function(e){if(X.current)if(claimedSwipeInstance=null,X.current=!1,W(!1),Y.current.isSwiping){Y.current.isSwiping=null;var r,n=getAnchor(t,o),a=isHorizontal(o);r=a?calculateCurrentX(n,e.changedTouches,ownerDocument(e.currentTarget)):calculateCurrentY(n,e.changedTouches,ownerWindow(e.currentTarget));var i=a?Y.current.startX:Y.current.startY,s=getMaxTranslate(a,L.current),c=getTranslate(r,i,S,s),u=c/s;Math.abs(Y.current.velocity)>h&&(B.current=1e3*Math.abs((s-c)/Y.current.velocity)),S?Y.current.velocity>h||u>f?w():G(0,{mode:"exit"}):Y.current.velocity<-h||1-u>f?P():G(getMaxTranslate(a,L.current),{mode:"enter"})}else Y.current.isSwiping=null}),V=useEventCallback(function(e){if(L.current&&X.current&&(null===claimedSwipeInstance||claimedSwipeInstance===Y.current)){var r=getAnchor(t,o),n=isHorizontal(o),a=calculateCurrentX(r,e.touches,ownerDocument(e.currentTarget)),i=calculateCurrentY(r,e.touches,ownerWindow(e.currentTarget));if(S&&L.current.contains(e.target)&&null===claimedSwipeInstance){if(computeHasNativeHandler({domTreeShapes:getDomTreeShapes(e.target,L.current),start:n?Y.current.startX:Y.current.startY,current:n?a:i,anchor:o}))return void(claimedSwipeInstance=!0);claimedSwipeInstance=Y.current}if(null==Y.current.isSwiping){var s=Math.abs(a-Y.current.startX),c=Math.abs(i-Y.current.startY),l=n?s>c&&s>UNCERTAINTY_THRESHOLD:c>s&&c>UNCERTAINTY_THRESHOLD;if(l&&e.cancelable&&e.preventDefault(),!0===l||(n?c>UNCERTAINTY_THRESHOLD:s>UNCERTAINTY_THRESHOLD)){if(Y.current.isSwiping=l,!l)return void j(e);Y.current.startX=a,Y.current.startY=i,u||S||(n?Y.current.startX-=DRAG_STARTED_SIGNAL:Y.current.startY-=DRAG_STARTED_SIGNAL)}}if(Y.current.isSwiping){var p=getMaxTranslate(n,L.current),d=n?Y.current.startX:Y.current.startY;S&&!Y.current.paperHit&&(d=Math.min(d,p));var m=getTranslate(n?a:i,d,S,p);if(S)if(Y.current.paperHit)0===m&&(Y.current.startX=a,Y.current.startY=i);else{if(!(n?a<p:i<p))return;Y.current.paperHit=!0,Y.current.startX=a,Y.current.startY=i}null===Y.current.lastTranslate&&(Y.current.lastTranslate=m,Y.current.lastTime=performance.now()+1);var f=(m-Y.current.lastTranslate)/(performance.now()-Y.current.lastTime)*1e3;Y.current.velocity=.4*Y.current.velocity+.6*f,Y.current.lastTranslate=m,Y.current.lastTime=performance.now(),e.cancelable&&e.preventDefault(),G(m)}}}),z=useEventCallback(function(e){if(!e.defaultPrevented&&!e.defaultMuiPrevented&&(!S||O.current.contains(e.target)||L.current.contains(e.target))){var r=getAnchor(t,o),n=isHorizontal(o),a=calculateCurrentX(r,e.touches,ownerDocument(e.currentTarget)),i=calculateCurrentY(r,e.touches,ownerWindow(e.currentTarget));if(!S){if(p||e.target!==k.current)return;if(n){if(a>A)return}else if(i>A)return}e.defaultMuiPrevented=!0,claimedSwipeInstance=null,Y.current.startX=a,Y.current.startY=i,W(!0),!S&&L.current&&G(getMaxTranslate(n,L.current)+(u?15:-DRAG_STARTED_SIGNAL),{changeTransition:!1}),Y.current.velocity=0,Y.current.lastTime=null,Y.current.lastTranslate=null,Y.current.paperHit=!1,X.current=!0}});return React.useEffect(function(){if("temporary"===C){var e=ownerDocument(L.current);return e.addEventListener("touchstart",z),e.addEventListener("touchmove",V,{passive:!S}),e.addEventListener("touchend",j),function(){e.removeEventListener("touchstart",z),e.removeEventListener("touchmove",V,{passive:!S}),e.removeEventListener("touchend",j)}}},[C,S,z,V,j]),React.useEffect(function(){return function(){claimedSwipeInstance===Y.current&&(claimedSwipeInstance=null)}},[]),React.useEffect(function(){S||W(!1)},[S]),React.createElement(React.Fragment,null,React.createElement(Drawer,_extends({open:!("temporary"!==C||!M)||S,variant:C,ModalProps:_extends({BackdropProps:_extends({},g,{ref:O})},y),PaperProps:_extends({},R,{style:_extends({pointerEvents:"temporary"!==C||S?"":"none"},R.style),ref:L}),anchor:o,transitionDuration:B.current||x,onClose:w,ref:r},N)),!p&&"temporary"===C&&React.createElement(NoSsr,null,React.createElement(SwipeArea,_extends({anchor:o,ref:k,width:A},D))))});"production"!==process.env.NODE_ENV&&(SwipeableDrawer.propTypes={anchor:PropTypes.oneOf(["bottom","left","right","top"]),children:PropTypes.node,disableBackdropTransition:PropTypes.bool,disableDiscovery:PropTypes.bool,disableSwipeToOpen:PropTypes.bool,hideBackdrop:PropTypes.bool,hysteresis:PropTypes.number,minFlingVelocity:PropTypes.number,ModalProps:PropTypes.shape({BackdropProps:PropTypes.shape({component:elementTypeAcceptingRef})}),onClose:PropTypes.func.isRequired,onOpen:PropTypes.func.isRequired,open:PropTypes.bool.isRequired,PaperProps:PropTypes.shape({component:elementTypeAcceptingRef,style:PropTypes.object}),SwipeAreaProps:PropTypes.object,swipeAreaWidth:PropTypes.number,transitionDuration:PropTypes.oneOfType([PropTypes.number,PropTypes.shape({appear:PropTypes.number,enter:PropTypes.number,exit:PropTypes.number})]),variant:PropTypes.oneOf(["permanent","persistent","temporary"])});export default SwipeableDrawer;