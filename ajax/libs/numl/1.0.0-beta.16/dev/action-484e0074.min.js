import{W as WidgetBehavior,A as ALIAS_ATTR,c as deepQuery,h,q as queryById,j as Routing,i as isEqual}from"./index-a5c9c958.js";import{handleLinkState,handleLinksState}from"./current-23a84d31.js";class ActionBehavior extends WidgetBehavior{static get params(){return{input:!0,role:"button"}}init(){this.value=null,this.offValue=null,this.require("active","focus","hover");const t=ALIAS_ATTR(this.host,"pressed");this.props.to=null,this.props.pressed=(t=>this.set(null!=t,!0)),this.props.checked=t,this.props.selected=t,this.setMod("action",!0),super.init();const{host:e}=this;e.NuAction=this,this.on("keydown",t=>{"Escape"===t.key&&e.nuHasAria("expanded")&&this.set(!1),this.listbox&&(this.ignorePopup=!0,t.nuListBoxHandled||(this.listbox.host.focus(),"Enter"!==t.key&&" "!==t.key&&this.listbox.onKeyDown(t)),setTimeout(()=>{this.ignorePopup=!1},100))}),this.radioGroup=null,this.to&&this.changed("to",this.to)}connected(){super.connected(),this.linkContext("radiogroup",()=>this.verifyRadioGroup(),"radioGroup"),"button"===this.role&&this.to&&(this.role="link"),this.createLink(),this.setContext("button",this)}disconnected(){this.radioGroup&&this.radioGroup.removeItem(this)}changed(t,e){if(super.changed(t,e),"to"===t){this.createLink();const{$link:t}=this;t&&(t.href=this.href,t.target=this.newTab?"_blank":"_self")}}verifyRadioGroup(){const t=this.radioGroup;t&&(t.addItem(this),this.setAttr("link-value",""),this.role=t.params.itemRole,null==this.value&&(t.counter||(t.counter=0),this.setValue(String(t.counter++))),this.fromContextValue(t.value))}linkPopup(t){this.popup||(this.popup=t,this.setAria("haspopup",!0),this.setAria("expanded",this.pressed||!1),this.setMod("dropdown",!0),this.listbox&&this.setAria("haspopup","listbox"))}unlinkPopup(t){if(this.popup!==t)return;const{host:e}=this;delete this.popup,e.nuSetAria("haspopup",null),e.nuSetAria("expanded",null),this.role=this.host.constructor.nuRole,this.setMod("dropdown",!1)}createLink(){const{host:t}=this;let e;this.to?(this.$link?e=this.$link:((e=deepQuery(t,"a"))||(e=h("a")),e.href=this.href,e.target=this.newTab?"_blank":"_self",e.setAttribute("tabindex","-1"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","none"),e.innerHTML="",this.$link=e,setTimeout(()=>{t.appendChild(this.$link),handleLinkState(t)}),this.$link.addEventListener("click",t=>{this.disabled?t.preventDefault():(0!==t.button||this.disabled||this.tap(t),t.stopPropagation())})),e.href=this.href,e.target=this.newTab?"_blank":"_self",(e&&e.href).includes("//")?this.$link.setAttribute("rel","noreferrer"):this.$link.removeAttribute("rel")):this.$link&&(delete this.$link,t.removeChild(this.$link))}tap(t){const{host:e}=this;if(this.to&&t.target!==this.$link)this.$link.click();else{if(this.to&&t.target===this.$link&&this.href.startsWith("#")){const s=this.href.slice(1),i=queryById(e,s);if(i)return i.scrollIntoView({behavior:"smooth"}),history.replaceState(null,"",`#${s}`),t.preventDefault(),handleLinksState(!0),void setTimeout(()=>{this.emit("tap"),setTimeout(()=>{handleLinksState()})},0)}if(!(this.disabled||this.isRadio()&&this.pressed)){if(this.scrollto&&e.nuScrollTo(this.scrollto),this.to){const e=this.to,s=e.replace(/^!/,""),i=e.startsWith("!")||t.metaKey||t.shiftKey;Routing.route(s,i)||(t.preventDefault(),t.stopPropagation()),this.doAction("close",!0)}setTimeout(()=>{this.emit("tap"),setTimeout(()=>{handleLinksState()})},0),this.isToggle()?this.toggle():(this.popup||this.control(),this.doActions(this.value))}}}get emitValue(){return this.isToggle()?null!=this.value?this.pressed?this.value:null!=this.offValue?this.offValue:this.value:this.pressed:this.value}toggle(){this.isToggle()&&(this.pressed&&!this.isUnpressable()||this.set(!this.pressed))}set(t,e,s){if(t===this.pressed)return;if(!this.isToggle()&&!s)return;const{host:i}=this;t=t||!1,this.pressed=t,t&&this.isRadio()&&this.radioGroup&&this.radioGroup.setCurrent(this),this.popup?i.nuSetAria("expanded",t):this.isCheckbox()?i.nuSetAria("checked",t):this.isSelectable()?i.nuSetAria("selected",t):i.nuSetAria("pressed",t),!e&&this.isToggle()&&(this.emit("pressed",this.pressed),this.popup||this.emit("input",this.emitValue)),this.popup||this.control(e&!this.hasAttr("trigger")),t&&this.listbox&&this.listbox.host.focus(),this.setMod("pressed",t),this.setContext("disabled",!t),t&&this.doActions(this.value),this.toggleInnerPopup()}toggleInnerPopup(t,e){const s=this.host.nuDeepQuery(`[is-popup]${e?":not([multiple])":""}`),i=null==t?this.pressed?"open":"close":t?"open":"close";s&&s.nuPopup[i]()}setValue(t,e){this.ignorePopup||this.toggleInnerPopup(!1,!0),super.setValue(t,e)}setByValue(t){let e=this.value,s=this.offValue;if(null!=e)return e=this.getTypedValue(e),isEqual(e,t)?this.set(!0):(null!=s&&(s=this.getTypedValue(s)),this.set(!1));this.set(null!=t)}isToggle(){const{host:t}=this;return t.hasAttribute("toggle")||t.nuHasAria("pressed")||t.nuHasAria("expanded")||t.nuHasAria("checked")||t.nuHasAria("selected")||["checkbox","radio","tab","switch"].includes(this.role)}isUnpressable(){return!["radio","tab"].includes(this.role)}isRadio(){return["radio","tab"].includes(this.role)}isSelectable(){return["tab"].includes(this.role)}isCheckbox(){return["radio","checkbox","switch"].includes(this.role)}fromContextValue(t){this.isToggle()&&null!=t&&this.set(isEqual(this.value,t))}control(t){let e=null;this.isToggle()&&!this.valueBubbled&&(e=!!this.pressed),this.use("control").then(s=>s.apply(e,this.getTypedValue(this.emitValue),t))}get href(){const{to:t=""}=this;return t.replace(/^!/,"")}get newTab(){const{to:t=""}=this;return t.startsWith("!")}}export default ActionBehavior;